var fs = require("fs");
var path = require('path');
var getLogConfig = require("./ConfigHelper").getLogConfig;
var Log  = function(){};

/*
* get the configure information of DefaultConfigure.json
*/
Object.defineProperty(Log,"getConfigByName",{
  value:function(name){
    return getLogConfig(name);
  }
});

//make directory for log file 
Object.defineProperty(Log,"mkdir",{
  value:function(dirpath,dirname){
    //whether the first be called
    if(typeof dirname === "undefined"){ //first call
      if(fs.existsSync(dirpath)){
        return;
      }else{
        arguments.callee(dirpath,path.dirname(dirpath));
      }
    }else{
      if(dirname !== path.dirname(dirpath)){ 
        arguments.callee(dirpath);
        return;
      }
      if(fs.existsSync(dirname)){
        fs.mkdirSync(dirpath)
      }else{
        arguments.callee(dirname,path.dirname(dirname));
        fs.mkdirSync(dirpath);
      }
    }
  }
});

/**
  Log to log2terminal
*/
Object.defineProperty(Log,"log2terminal",{
  value:function(text,level,stack){
    text = JSON.stringify(text).replace(/\\\"/g,"\'")
    var context = Log.getHeader(level,stack)+text;
    console.log(context);
  }
});

/**
  Log to txt
*/
Object.defineProperty(Log,"log2txt",{
  value:function(text,level,stack){
      text = JSON.stringify(text).replace(/\\\"/g,"\'");
      var logDir = Log.getConfigByName("logDir")
      Log.mkdir(logDir);
      var fullpath =  path.join(logDir,Log.getLogFileName(level));
      var context = Log.getHeader(level,stack)+text+"\n";
      fs.appendFile(fullpath,context, function (err) {
          if (err) throw err;
      });
  }
});

/**
 get log file name
*/
Object.defineProperty(Log,"getLogFileName",{
  value:function(level){
      var filename = new Date().format(Log.getConfigByName("fileDateformat"));
        return Log.getConfigByName("logRate")
                ? filename+"_"+Log.getLevel(level)+".log"
                : filename+".log"
  }
});


/*
*获取日志级别
*/
Object.defineProperty(Log,"getLevel",{
  value:function(level){
    var levelInfo = "";
    switch(level){
        case -1:levelInfo = "ERROR";break;
        case 0 :levelInfo = "WARNNING";break;
        default:levelInfo = "NORMAL";break;
    }
    return levelInfo;
  }
});

/*
*set every line the header ,include the log time,log level and the file line; 
*/
Object.defineProperty(Log,"getHeader",{
  value:function(level,stack){
    if(typeof level === "undefined" || typeof level !== "number") 
       level = 1;

    var header = "";
    var headerConfig =  Log.getConfigByName("headerInfo");
    if(headerConfig.time)
      header = new Date().format(Log.getConfigByName("logDateformat")) + "  ";
    if(headerConfig.level)
      header = header + Log.getLevel(level) + "  ";
    if(headerConfig.stack)
       header = header + stack + "\n";
    return header
  }
});

Object.defineProperty(Log,"print",{
    value:function(text,level,error){
        var stack = error.stack.replace(/^Error(\s)*/,"");
        stack = stack.split('\n')[1];
        reg = new RegExp(process.cwd(),"g");
        stack = stack.replace(reg,"");
        arguments[2] = stack;
        Log[Log.getConfigByName("method")].apply(null,arguments);
    }
});

/*
info
  log normal information
  parameters:
    context  type:object;

warn
  log warning information
  parameters:
    context  type:object;

error
  log error information
  parameters:
    context  type:object;
*/
var Log4js = function(){};
Object.defineProperties(Log4js,{
  "info":{
    "value":function(context){
      var err = new Error();
      Log.print(context,1,err);
    }
  },
  "warn":{
    "value":function(context){
      var err = new Error();
      Log.print(context,0,err);
    }
  },
  "error":{
    "value":function(context){
      var err = new Error();
      Log.print(context,-1,err);
    }
  }
});


module.exports = Log4js;