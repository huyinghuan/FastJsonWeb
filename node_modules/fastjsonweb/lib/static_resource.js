/**
  静态资源管理
  需改善：文件类型列表 
**/
var url = require('url');
var path = require('path');  
var fs = require('fs');
var mime = require('./mime').types;
function StaticResource(){
  this.execute = function(request,response){
    var uri =  url.parse(request.url).pathname;
    var filename = path.join(process.cwd(),uri);
    fs.exists(filename,function(exists){
		if(!exists){
			response.writeHead(404,{"Content-Type":"text/plain"});
			response.write("404,请求资源"+uri+"不存在");
			response.end();
			return;
		}
		//文件类型判断 是否访问的是文件夹
		var ext = path.extname(filename);
		if(ext === ""){
			response.writeHead(403,{"Content-Type":"text/plain"});
			response.write("禁止访问","UTF-8"); 
			response.end();
			return;
		}
		ext = ext ? ext.slice(1).toLocaleUpperCase() :'unkown';
		var contentType=mime[ext] || "text/plain";
		/*
		fs.readFile(filename,function(err,data){
			if(err){
				response.writeHead(500,{"Content-Type":"text/plain"});
				response.write("500,服务器内部错误");
				response.end();
				console.log(err); //增加一个日志记录模块
				return;
			}
			response.writeHead(200, { 'Content-Type': contentType});  
			response.write(data,"binary"); 
			response.end();
		});
		*/
		var fileStream = fs.createReadStream(filename);
		response.setHeader("Content-Disposition", "inline;");
		response.writeHead(200, {"Content-Type": contentType});
		fileStream.pipe(response);
		fileStream.on("end", function() {
			response.end();
		})
    });
  };
}
module.exports = StaticResource;
