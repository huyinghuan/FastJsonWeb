var list = [
  require("./filters/dealwithSession")
];
var listLength =  list.length;

function loop(flag,req,resp,fn){
    if(flag < 0)
      return fn;
    if(flag === 0){
       return function(){
          list[listLength-1].deal(req,resp,fn);
       }
    }
    return function(){
         list[listLength -1 -flag].deal(req,resp,loop(flag-1,req,resp,fn));     
      }
}

exports.filterlist = function(request,response,fn){
  list[0].deal(request,response,loop(listLength-2,request,response,fn));
}

//以上为fastjsonweb处理

//以下为 开发者自定义处理

var systemPathUtils = require('path');

function definedLoop(flag,req,resp,fn,list,listLength,dirPath){
  if(flag < 0)
    return fn;
  if(flag === 0){
      return function(){
         require(getRealPath(dirPath,list[listLength-1])).doFilter(req,resp,fn)
      }
   }
   return function(){
      require(getRealPath(dirPath,list[listLength -1 -flag]))
        .doFilter(req,resp,definedLoop(flag-1,req,resp,fn,list,listLength,dirPath));
   }
}

function getRealPath(dirPath,filePath){
  dirpath = systemPathUtils.join(process.cwd(),dirPath);
  return systemPathUtils.join(dirpath,filePath);
}
exports.definedFilterList = function(request,response,fn){
  var filters = require('./globelsetting').getFilter();
  var filterlist  = filters.sequence;
  var filterLength = filterlist.length;
  var path = filters.path;
  if(!filterLength){
    fn();
    return;
  }
  require(getRealPath(path,filterlist[0]))
    .doFilter(request,response,definedLoop(filterLength-2,request,response,fn,filterlist,filterLength,path));

}
