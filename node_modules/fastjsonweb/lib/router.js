/**
路由功能
	接收一个路径，找到相应的处理文件action，返回该action的处理函数
	
	====================================================================================
	1.修改route函数，增加URL 动态方法调用功能
	2.修改dynamicPath参数列表，增加method参数。
	via:  ec.huyinghuan@gmail.com  Date: 2013.02.07
	
	=====================================================================================
	
	1.删除 dynamicPath ，staticPath 函数  
	2.修改route函数，修改其返回值为Object（属性2个 object：路径映射的类 method:动态调用的方法）
	via:  ec.huyinghuan@gmail.com  Date: 2013.02.16
**/

var routerHandle = require('./routerHandle');
var smartrouter = require("./smartrouter");
/*
var staticResourcePath  =  requestHandle.staticResourceDir; //配置静态资源文件夹位置
var handle = requestHandle.handle;
var errorMessage ='';
*/
//判断是否为静态资源
function isStaticResorce(path){
  if(!path)return false;
  if(path.indexOf(routerHandle.staticResourceDir) != -1){  //静态资源判断
		 return true;
	}
	return false;
}

function route(path){
//	var handle = routerHandle.handle;
	var arr = path.split('\!'); //从URL 中解析出 需调用的方法，若没有则默认执行execute方法
	if(arr.length > 2){
		errorMessage = "ERROR: The path \'"+path+"\' is wrong at \'!\',there is two \'!\' or more.";
		console.log(errorMessage);
	}else if(arr.length == 1){
		arr[1] = "execute";
	}
	var action = {};
	path = arr[0];
	var method = arr[1];
	//测试  //测试通过
	/*
	(function(){
		var systempath = require('path');  
		var actionpath = systempath.join(process.cwd(),"/action/test/uuid");
		console.log("请求的uri"+actionpath);
		console.log("测试获取的uuid是"+require(actionpath).getUUID());
		
		var actionpath2 = systempath.join(process.cwd(),"/action/test/uuid2");
		try{
			var ac = require(actionpath2);
		}catch(err){
			console.log("异常捕捉");
			console.log(err);
		}	
	})();
	*/
	/*
	if(typeof handle[path] === 'function'){
		action["object"] =  handle[path];
		action["method"] =  method;
	}else{
		action["object"] =  routerHandle.requestNotFound;//404错误处理
		action["method"] = 'execute';
	}
	return action;
	*/
	var systempath = require('path');
	var realpath = smartrouter.getRealPath(path);
	console.log("访问的路径是"+path+" ==== 映射到的物理路径是"+ realpath);
	var actionpath = systempath.join(process.cwd(),realpath);
	try{
		if(actionpath === process.cwd()){
			throw new Error(path + "is not exist ");
		}
		action["object"] = require(actionpath);
		action["method"] =  method;
	}catch(err){
		action["object"] =  routerHandle.requestNotFound;//404错误处理
		action["method"] = 'execute';
	}
	return action;
}
exports.route = route;
exports.isStaticResorce = isStaticResorce;
